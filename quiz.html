<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿ç­”é¢˜</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="brand">
            <span>ğŸ“š</span>
            <span id="library-name">è‡ªå®šä¹‰é¢˜åº“</span>
        </div>
        <div class="exam-info">
            <div class="info-item">æ€»é¢˜æ•°ï¼š<span id="total-count">0</span></div>
            <div class="info-item">å·²ç­”ï¼š<span id="answered-count">0</span></div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="window.location.href='library.html'">è¿”å›é¢˜åº“</button>
            <button id="submit-exam-btn" class="btn btn-success">äº¤å·æŸ¥çœ‹æˆç»©</button>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="sidebar-header">ç­”é¢˜å¡</div>
            <div style="padding: 0 15px;">
                <div class="card-legend">
                    <div class="legend-item"><div class="dot current"></div>å½“å‰</div>
                    <div class="legend-item"><div class="dot done"></div>å·²ç­”</div>
                    <div class="legend-item"><div class="dot wrong"></div>é”™è¯¯</div>
                </div>
            </div>
            <div id="question-grid" class="question-grid"></div>
        </aside>

        <main class="content-area">
            <div class="question-card">
                <div id="question-type" class="q-type-badge">å•é€‰é¢˜</div>
                <div id="question-text" class="q-content"></div>
                <div id="options-container" class="options-group"></div>
                
                <div id="analysis-box" class="analysis-box">
                    <div class="analysis-header" id="analysis-title">è§£æ</div>
                    <div class="analysis-content" id="analysis-text"></div>
                </div>
            </div>
        </main>
    </div>

    <div class="action-bar">
        <button id="prev-btn" class="btn btn-secondary">ä¸Šä¸€é¢˜</button>
        <button id="check-btn" class="btn btn-primary">ç¡®è®¤ç­”æ¡ˆ</button>
        <button id="next-btn" class="btn btn-secondary">ä¸‹ä¸€é¢˜</button>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>è€ƒè¯•ç»“æŸ</h2>
            <div class="score-display"><span id="final-score">0</span><span style="font-size: 20px; color: #666">åˆ†</span></div>
            <div class="score-detail">
                <div>æ­£ç¡®: <span id="correct-count" style="color:#34a853; font-weight:bold">0</span></div>
                <div>é”™è¯¯: <span id="wrong-count" style="color:#ea4335; font-weight:bold">0</span></div>
                <div>æ­£ç¡®ç‡: <span id="accuracy-rate">0%</span></div>
            </div>
            <button id="close-modal-btn" class="btn btn-primary">å…³é—­</button>
        </div>
    </div>

    <script>
        let quizData = [];
        let currentQuestionIndex = 0;
        let userState = { answers: {}, results: {} };

        const getOptionLabel = (index) => String.fromCharCode(65 + index);

        document.addEventListener('DOMContentLoaded', () => {
            // Load selected library
            const libraryData = sessionStorage.getItem('selectedLibrary');
            if (!libraryData) {
                alert('æœªé€‰æ‹©é¢˜åº“');
                window.location.href = 'library.html';
                return;
            }

            const library = JSON.parse(libraryData);
            quizData = library.questions;
            document.getElementById('library-name').textContent = library.name;
            
            if (quizData.length === 0) {
                alert('é¢˜åº“ä¸ºç©º');
                window.location.href = 'library.html';
                return;
            }

            initQuiz();
        });

        function initQuiz() {
            document.getElementById('total-count').textContent = quizData.length;
            renderQuestionGrid();
            loadQuestion(0);

            document.getElementById('prev-btn').addEventListener('click', () => navigate(-1));
            document.getElementById('next-btn').addEventListener('click', () => navigate(1));
            document.getElementById('check-btn').addEventListener('click', submitCurrentAnswer);
            document.getElementById('submit-exam-btn').addEventListener('click', finishExam);
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('result-modal').style.display = 'none';
            });
        }

        function renderQuestionGrid() {
            const grid = document.getElementById('question-grid');
            grid.innerHTML = '';
            quizData.forEach((q, index) => {
                const cell = document.createElement('div');
                cell.className = 'q-cell';
                cell.textContent = index + 1;
                cell.id = `q-cell-${index}`;
                cell.addEventListener('click', () => loadQuestion(index));
                grid.appendChild(cell);
            });
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            const question = quizData[index];
            updateAllGridStatus();

            const typeBadge = document.getElementById('question-type');
            let typeText = question.type === 'single' ? 'å•é€‰é¢˜' : question.type === 'multiple' ? 'å¤šé€‰é¢˜' : 'åˆ¤æ–­é¢˜';
            typeBadge.textContent = `${index + 1}. ${typeText}`;

            document.getElementById('question-text').textContent = question.question;

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            const savedSelection = userState.answers[question.id] || [];
            const isChecked = !!userState.results[question.id];

            question.options.forEach((optText, i) => {
                const row = document.createElement('div');
                row.className = 'option-row';
                
                if (savedSelection.includes(i)) row.classList.add('selected');

                if (isChecked) {
                    const label = getOptionLabel(i);
                    if (question.answer.includes(label)) {
                        row.classList.add('correct-highlight');
                    } else if (savedSelection.includes(i)) {
                        row.classList.add('wrong-highlight');
                    }
                    row.style.cursor = 'default';
                } else {
                    row.addEventListener('click', () => handleOptionClick(i, question));
                }

                row.innerHTML = `<span class="opt-label">${getOptionLabel(i)}</span><div class="opt-text">${optText}</div>`;
                container.appendChild(row);
            });

            const analysisBox = document.getElementById('analysis-box');
            if (isChecked) {
                analysisBox.classList.add('show');
                const isCorrect = userState.results[question.id] === 'correct';
                analysisBox.className = `analysis-box show ${isCorrect ? 'correct' : 'wrong'}`;
                document.getElementById('analysis-title').innerHTML = isCorrect ? 'âœ… å›ç­”æ­£ç¡®' : `âŒ å›ç­”é”™è¯¯ (æ­£ç¡®ç­”æ¡ˆ: ${question.answer.join('')})`;
                document.getElementById('analysis-text').textContent = question.explanation || 'æš‚æ— è§£æ';
                document.getElementById('check-btn').style.display = 'none';
            } else {
                analysisBox.classList.remove('show');
                document.getElementById('check-btn').style.display = 'block';
            }

            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === quizData.length - 1;
        }

        function handleOptionClick(optionIndex, question) {
            let selection = userState.answers[question.id] || [];
            if (question.type === 'single' || question.type === 'boolean') {
                selection = [optionIndex];
            } else {
                const idx = selection.indexOf(optionIndex);
                idx > -1 ? selection.splice(idx, 1) : selection.push(optionIndex);
            }
            userState.answers[question.id] = selection;
            loadQuestion(currentQuestionIndex);
            updateStats();
        }

        function submitCurrentAnswer() {
            const question = quizData[currentQuestionIndex];
            const selection = userState.answers[question.id] || [];
            if (selection.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé€‰é¡¹');
                return;
            }
            const userLabels = selection.map(i => getOptionLabel(i)).sort();
            const correctLabels = question.answer.sort();
            userState.results[question.id] = JSON.stringify(userLabels) === JSON.stringify(correctLabels) ? 'correct' : 'wrong';
            loadQuestion(currentQuestionIndex);
            updateStats();
        }

        function navigate(direction) {
            const newIndex = currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < quizData.length) loadQuestion(newIndex);
        }

        function updateStats() {
            document.getElementById('answered-count').textContent = Object.keys(userState.answers).length;
            updateAllGridStatus();
        }

        function updateAllGridStatus() {
            quizData.forEach((q, i) => {
                const cell = document.getElementById(`q-cell-${i}`);
                if (!cell) return;
                cell.className = 'q-cell';
                if (i === currentQuestionIndex) cell.classList.add('active');
                const result = userState.results[q.id];
                if (result === 'correct') cell.classList.add('correct');
                else if (result === 'wrong') cell.classList.add('wrong');
                else if (userState.answers[q.id]?.length > 0) cell.classList.add('answered');
            });
        }

        function finishExam() {
            quizData.forEach(q => {
                if (userState.answers[q.id] && !userState.results[q.id]) {
                    const userLabels = userState.answers[q.id].map(i => getOptionLabel(i)).sort();
                    const correctLabels = q.answer.sort();
                    userState.results[q.id] = JSON.stringify(userLabels) === JSON.stringify(correctLabels) ? 'correct' : 'wrong';
                }
            });

            const correct = Object.values(userState.results).filter(r => r === 'correct').length;
            const wrong = Object.values(userState.results).filter(r => r === 'wrong').length;
            const score = Math.round((correct / quizData.length) * 100);

            document.getElementById('final-score').textContent = score;
            document.getElementById('correct-count').textContent = correct;
            document.getElementById('wrong-count').textContent = wrong;
            document.getElementById('accuracy-rate').textContent = score + '%';
            document.getElementById('result-modal').style.display = 'flex';
            updateAllGridStatus();
        }
    </script>
</body>
</html>

